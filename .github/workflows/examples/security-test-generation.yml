name: Auto-Generate Security Tests

on:
  pull_request:
    types: [labeled]

  workflow_dispatch:

jobs:
  generate-tests:
    # Only run when 'needs-security-tests' label is applied
    if: contains(github.event.pull_request.labels.*.name, 'needs-security-tests') || github.event_name == 'workflow_dispatch'

    name: Generate Security Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Security Tests
        id: review
        uses: securedotcom/argus-action@v2.2.0
        with:
          # AI Provider Configuration
          ai-provider: anthropic
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Enable only security test generation
          multi-agent-mode: 'sequential'
          enable-exploit-analysis: 'false'  # Skip exploit analysis
          generate-security-tests: 'true'   # Only generate tests

          # Don't fail build, just generate tests
          fail-on-blockers: 'false'
          fail-on: ''

          # Lower budget for faster execution
          max-cost-usd: '1.00'
          comment-on-pr: 'true'

      - name: Display Generated Tests
        if: always()
        run: |
          echo "## Security Tests Generated"
          echo ""
          echo "**Tests Generated**: ${{ steps.review.outputs.tests-generated }}"
          echo ""
          if [ -d "tests/security" ]; then
            echo "### Generated Test Files:"
            find tests/security -type f -name "*.py" -o -name "*.js" -o -name "*.ts" | while read file; do
              echo "- $file"
            done
          else
            echo "No test files found in tests/security/"
          fi

      - name: Commit Generated Tests
        if: steps.review.outputs.tests-generated > 0
        run: |
          git config --global user.name 'Argus Bot'
          git config --global user.email 'bot@argus.com'

          # Add generated tests
          if [ -d "tests/security" ]; then
            git add tests/security/
          fi

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new tests to commit"
          else
            git commit -m "Auto-generated security tests

Tests generated by Argus Aardvark mode.

Number of test files: ${{ steps.review.outputs.tests-generated }}

Generated with [Argus](https://github.com/securedotcom/argus-action)

Co-Authored-By: Argus <noreply@secured.com>"

            # Push to the current branch
            git push
            echo "âœ… Successfully committed and pushed generated tests"
          fi

      - name: Comment on PR with Test Summary
        if: github.event.pull_request && steps.review.outputs.tests-generated > 0
        uses: actions/github-script@v7
        with:
          script: |
            const testsGenerated = '${{ steps.review.outputs.tests-generated }}';

            const body = '## ðŸ§ª Security Tests Auto-Generated\n\n' +
                         `Argus has generated **${testsGenerated} security test file(s)** for this PR.\n\n` +
                         '### Generated Tests\n\n' +
                         'The following security tests have been created:\n\n' +
                         '```\n' +
                         'tests/security/\n' +
                         'â”œâ”€â”€ Unit tests for discovered vulnerabilities\n' +
                         'â”œâ”€â”€ Integration tests for exploit chain prevention\n' +
                         'â””â”€â”€ Fuzz tests for input validation\n' +
                         '```\n\n' +
                         '### Next Steps\n\n' +
                         '1. Review the generated tests\n' +
                         '2. Run the tests: `pytest tests/security/` or `npm test`\n' +
                         '3. Enhance tests as needed\n' +
                         '4. Ensure all tests pass before merging\n\n' +
                         '**Note**: Generated tests provide baseline coverage but should be reviewed and enhanced by developers.\n\n' +
                         '---\n' +
                         'Generated by [Argus Aardvark Mode](https://github.com/securedotcom/argus-action)';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Upload Generated Tests Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-security-tests-${{ github.run_id }}
          path: tests/security/
          retention-days: 90
          if-no-files-found: ignore
