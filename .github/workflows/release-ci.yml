name: Release Branch CI

on:
  push:
    branches:
      - 'release/**'
  pull_request:
    branches:
      - 'release/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
        with:
          fetch-depth: 0
      
      - name: Extract version from branch
        id: version
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${BRANCH_NAME#release/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 3.2.0)"
            exit 1
          fi
          echo "✅ Version format valid: $VERSION"
      
      - name: Check version increment
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION="${LATEST_TAG#v}"
          NEW_VERSION="${{ steps.version.outputs.version }}"
          
          echo "Latest version: $LATEST_VERSION"
          echo "New version: $NEW_VERSION"
          
          # Simple version comparison
          if [ "$NEW_VERSION" == "$LATEST_VERSION" ]; then
            echo "❌ Version must be incremented from $LATEST_VERSION"
            exit 1
          fi
          
          echo "✅ Version incremented: $LATEST_VERSION → $NEW_VERSION"
      
      - name: Check CHANGELOG exists
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "⚠️ Warning: CHANGELOG.md not found"
            echo "Consider adding a CHANGELOG.md file"
          else
            echo "✅ CHANGELOG.md exists"
          fi

  test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov ruff mypy
          # Install core dependencies (skip optional heavy ML dependencies)
          pip install anthropic openai tenacity pyyaml requests urllib3 certifi cryptography semgrep boto3 2>/dev/null || true
      
      - name: Run linters (strict)
        run: |
          ruff check scripts/
          ruff format --check scripts/
          flake8 scripts/ --max-line-length=120 --extend-ignore=E203,W503
      
      - name: Run tests with coverage
        run: |
          if [ -d tests ]; then
            pytest tests/ --cov=scripts --cov-report=xml --cov-report=term --cov-fail-under=80
          else
            echo "No tests directory found"
          fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/ci
          generateSarif: true
      
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  release-notes-check:
    name: Check Release Notes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7

      - name: Check for release notes
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${BRANCH_NAME#release/}"

          echo "Checking for release notes for version $VERSION"

          if [ -f "RELEASE_NOTES.md" ]; then
            echo "✅ RELEASE_NOTES.md found"
          else
            echo "⚠️ Warning: RELEASE_NOTES.md not found"
            echo "Consider creating release notes before merging"
          fi

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate-release, test, security-audit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install core dependencies (skip optional heavy ML dependencies)
          pip install anthropic openai tenacity pyyaml requests urllib3 certifi cryptography semgrep boto3 2>/dev/null || true
      
      - name: Generate SBOM
        run: |
          # Install Syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          
          # Generate SBOM
          syft dir:. -o cyclonedx-json > sbom.json
          echo "✅ SBOM generated"
      
      - name: Sign SBOM
        run: |
          # Install Cosign
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /usr/local/bin/cosign
          chmod +x /usr/local/bin/cosign
          
          # Generate ephemeral key pair for testing
          echo "⚠️ Using ephemeral keys for CI (production should use proper key management)"
          cosign generate-key-pair
          
          # Sign SBOM
          cosign sign-blob sbom.json \
            --key cosign.key \
            --bundle sbom.bundle.json \
            --tlog-upload=false \
            --yes
          
          echo "✅ SBOM signed"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: |
            sbom.json
            sbom.bundle.json
          retention-days: 30

  notify:
    name: Notify Release Status
    runs-on: ubuntu-latest
    needs: [validate-release, test, security-audit, build-artifacts, release-notes-check]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.validate-release.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.security-audit.result }}" == "success" ] && \
             [ "${{ needs.build-artifacts.result }}" == "success" ]; then
            echo "✅ Release branch ready for merge"
            echo "Next steps:"
            echo "1. Review all changes"
            echo "2. Update version numbers if needed"
            echo "3. Finalize release notes"
            echo "4. Merge to main using: git flow release finish <version>"
          else
            echo "❌ Release branch has failing checks"
            echo "Please fix all issues before merging"
            exit 1
          fi

