name: Hybrid Security Scan
# Combines Semgrep (SAST) + Trivy (CVE) + Foundation-Sec-8B (AI Analysis)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Weekly scan on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      enable_foundation_sec:
        description: 'Enable Foundation-Sec-8B AI enrichment'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      severity_filter:
        description: 'Severity levels to report (comma-separated)'
        required: false
        default: 'critical,high,medium'
      target_path:
        description: 'Path to scan (default: entire repo)'
        required: false
        default: '.'

permissions:
  contents: read
  security-events: write  # Required for SARIF upload
  pull-requests: write    # Required for PR comments
  issues: write

# Prevent concurrent runs on the same branch
concurrency:
  group: hybrid-security-${{ github.ref }}
  cancel-in-progress: false

jobs:
  hybrid-security-scan:
    name: Hybrid Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install core dependencies (skip optional heavy ML dependencies)
          pip install anthropic openai tenacity pyyaml requests urllib3 certifi cryptography semgrep boto3 || pip install anthropic openai requests PyYAML
      
      - name: Install Security Tools
        run: |
          echo "ðŸ“¦ Installing Semgrep and Trivy..."
          bash scripts/install_security_tools.sh
      
      - name: Cache Hugging Face Models
        if: github.event.inputs.enable_foundation_sec == 'true'
        uses: actions/cache@v3
        id: cache-hf-models
        with:
          path: ~/.cache/huggingface
          key: hf-foundation-sec-8b-${{ runner.os }}-v1
          restore-keys: |
            hf-foundation-sec-8b-${{ runner.os }}-

      - name: Setup Foundation-Sec-8B (Optional)
        if: github.event.inputs.enable_foundation_sec == 'true'
        timeout-minutes: 20
        continue-on-error: true
        id: setup_foundation_sec
        run: |
          echo "ðŸ¤– Installing Foundation-Sec-8B..."

          # Install dependencies
          pip install transformers torch accelerate bitsandbytes --quiet

          # Try to download/load model with timeout
          python3 << 'EOF'
          import sys
          import signal
          from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig
          import torch

          def timeout_handler(signum, frame):
              print("â±ï¸  Timeout: Model download/load taking too long")
              sys.exit(1)

          # Set 15 minute timeout
          signal.signal(signal.SIGALRM, timeout_handler)
          signal.alarm(900)

          try:
              if "${{ steps.cache-hf-models.outputs.cache-hit }}" == "true":
                  print("âœ… Using cached model")
              else:
                  print("ðŸ“¥ Downloading Foundation-Sec-8B model (first run, ~16GB)...")

              # Use 4-bit quantization to reduce memory
              quantization_config = BitsAndBytesConfig(
                  load_in_4bit=True,
                  bnb_4bit_compute_dtype=torch.float16
              )

              tokenizer = AutoTokenizer.from_pretrained("fdtn-ai/Foundation-Sec-8B")
              model = AutoModelForCausalLM.from_pretrained(
                  "fdtn-ai/Foundation-Sec-8B",
                  quantization_config=quantization_config,
                  device_map="auto",
                  low_cpu_mem_usage=True
              )

              print("âœ… Foundation-Sec-8B ready!")
              sys.exit(0)
          except Exception as e:
              print(f"âŒ Failed to load Foundation-Sec-8B: {e}")
              sys.exit(1)
          finally:
              signal.alarm(0)
          EOF

          echo "foundation_sec_loaded=true" >> $GITHUB_OUTPUT
        env:
          HF_HOME: ~/.cache/huggingface
      
      - name: Run Hybrid Security Scan
        id: hybrid_scan
        run: |
          echo "ðŸ”’ Starting Hybrid Security Analysis..."

          TARGET_PATH="${{ github.event.inputs.target_path || '.' }}"
          SEVERITY_FILTER="${{ github.event.inputs.severity_filter || 'critical,high,medium' }}"
          FOUNDATION_SEC_LOADED="${{ steps.setup_foundation_sec.outputs.foundation_sec_loaded || 'false' }}"

          # Build command
          CMD="python3 scripts/hybrid_analyzer.py $TARGET_PATH"
          CMD="$CMD --output-dir .argus/hybrid-results"
          CMD="$CMD --severity-filter $SEVERITY_FILTER"
          CMD="$CMD --enable-semgrep"
          CMD="$CMD --enable-trivy"

          # Only enable Foundation-Sec if it was successfully loaded
          if [[ "$FOUNDATION_SEC_LOADED" == "true" ]]; then
            echo "âœ… Foundation-Sec-8B available - enabling AI enrichment"
            CMD="$CMD --enable-foundation-sec"
          else
            echo "âš ï¸  Foundation-Sec-8B not available - running without AI enrichment"
            echo "ðŸ’¡ Scan will complete using Semgrep + Trivy only"
          fi

          # Run scan (allow non-zero exit for findings)
          set +e
          $CMD
          EXIT_CODE=$?
          set -e

          # Save exit code for later
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Always succeed workflow (findings reported via SARIF)
          exit 0
        continue-on-error: false
      
      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('.argus/hybrid-results/*.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .argus/hybrid-results/
          category: hybrid-security-scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Results as Artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: hybrid-security-results-${{ github.run_id }}
          path: .argus/hybrid-results/
          retention-days: 90
      
      - name: Parse Results for PR Comment
        if: always() && github.event_name == 'pull_request'
        id: parse_results
        run: |
          if compgen -G ".argus/hybrid-results/*.json" > /dev/null; then
            JSON_FILE=$(ls -t .argus/hybrid-results/*.json 2>/dev/null | head -1)
            
            if [ ! -f "$JSON_FILE" ]; then
              echo "No JSON results found"
              exit 0
            fi
            
            # Extract summary
            CRITICAL=$(jq -r '.findings_by_severity.critical // 0' "$JSON_FILE")
            HIGH=$(jq -r '.findings_by_severity.high // 0' "$JSON_FILE")
            MEDIUM=$(jq -r '.findings_by_severity.medium // 0' "$JSON_FILE")
            LOW=$(jq -r '.findings_by_severity.low // 0' "$JSON_FILE")
            TOTAL=$(jq -r '.total_findings // 0' "$JSON_FILE")
            DURATION=$(jq -r '.scan_duration_seconds // 0' "$JSON_FILE")
            COST=$(jq -r '.cost_usd // 0' "$JSON_FILE")
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "duration=$DURATION" >> $GITHUB_OUTPUT
            echo "cost=$COST" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const critical = '${{ steps.parse_results.outputs.critical }}';
            const high = '${{ steps.parse_results.outputs.high }}';
            const medium = '${{ steps.parse_results.outputs.medium }}';
            const low = '${{ steps.parse_results.outputs.low }}';
            const total = '${{ steps.parse_results.outputs.total }}';
            const duration = '${{ steps.parse_results.outputs.duration }}';
            const cost = '${{ steps.parse_results.outputs.cost }}';
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Determine status emoji
            let statusEmoji = 'âœ…';
            let statusText = 'No critical or high severity issues';
            
            if (parseInt(critical) > 0) {
              statusEmoji = 'ðŸ”´';
              statusText = 'Critical issues found!';
            } else if (parseInt(high) > 0) {
              statusEmoji = 'ðŸŸ ';
              statusText = 'High severity issues found';
            }
            
            const comment = `## ${statusEmoji} Hybrid Security Scan Results
            
            **Status**: ${statusText}
            
            ### ðŸ“Š Findings Summary
            
            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${critical} |
            | ðŸŸ  High | ${high} |
            | ðŸŸ¡ Medium | ${medium} |
            | ðŸŸ¢ Low | ${low} |
            | **ðŸ“ˆ Total** | **${total}** |
            
            ### ðŸ› ï¸ Tools Used
            - âœ… Semgrep (SAST)
            - âœ… Trivy (CVE Scanning)
            ${cost > 0 ? '- âœ… Foundation-Sec-8B (AI Enrichment)' : ''}
            
            ### ðŸ“ˆ Metrics
            - â±ï¸ Scan Duration: ${duration}s
            - ðŸ’° Cost: $${cost}
            
            ### ðŸ”— Links
            - [View Full Results](${runUrl})
            - [Download SARIF](${ runUrl}#artifacts)
            - [Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ---
            *Powered by [Argus Hybrid Analyzer](https://github.com/securedotcom/argus)*
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Hybrid Security Scan Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Check Fail Conditions
        if: always()
        run: |
          CRITICAL=${{ steps.parse_results.outputs.critical || '0' }}
          HIGH=${{ steps.parse_results.outputs.high || '0' }}
          
          echo "ðŸ“Š Final Check:"
          echo "   Critical: $CRITICAL"
          echo "   High: $HIGH"
          
          if [[ $CRITICAL -gt 0 ]] || [[ $HIGH -gt 0 ]]; then
            echo "âŒ FAIL: Found critical or high severity issues"
            echo "   Review the Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
            exit 1
          fi
          
          echo "âœ… PASS: No critical or high severity issues found"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”’ Hybrid Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results**:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ Critical: ${{ steps.parse_results.outputs.critical || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  High: ${{ steps.parse_results.outputs.high || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ Medium: ${{ steps.parse_results.outputs.medium || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¢ Low: ${{ steps.parse_results.outputs.low || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools**: Semgrep + Trivy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration**: ${{ steps.parse_results.outputs.duration || '0' }}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Security Tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

