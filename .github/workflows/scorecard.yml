name: "OpenSSF Scorecard"

# OpenSSF Scorecard - Repository Security Health Check
# Evaluates repo against security best practices

on:
  # Run on default branch changes
  branch_protection_rule:
  push:
    branches: [ main, master ]
  schedule:
    # Run every Saturday at 3 AM UTC
    - cron: '0 3 * * 6'
  workflow_dispatch:

# Minimal permissions - elevate per job
permissions: read-all

jobs:
  analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      # Needed to upload results to code-scanning dashboard
      security-events: write
      # Needed to gather repository data
      id-token: write
      contents: read
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
      with:
        persist-credentials: false
        fetch-depth: 0
    
    - name: Run OpenSSF Scorecard
      uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a  # v2.4.3
      with:
        results_file: results.sarif
        results_format: sarif
        # Publish results to enable badges
        publish_results: true
    
    # Upload results to GitHub's code scanning dashboard
    - name: Upload SARIF to Code Scanning
      uses: github/codeql-action/upload-sarif@afb54ba388a7dca6ecae48f608c4ff05ff4cc77a  # v3.25.15
      with:
        sarif_file: results.sarif
        category: openssf-scorecard
    
    # Upload results as artifact for review
    - name: Upload Scorecard Results
      uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: scorecard-results
        path: results.sarif
        retention-days: 30

# Security Notes:
# 1. All actions pinned by commit SHA
# 2. Least privilege permissions
# 3. Results published for transparency
# 4. Runs weekly for continuous monitoring
# 5. Evaluates 20+ security best practices

