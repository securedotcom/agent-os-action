name: Dependency Review

on:
  pull_request:
    branches: 
      - main
      - develop
      - master
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      
      - name: Dependency Review
        uses: actions/dependency-review-action@5a2ce3f5b92ee19cbb1541a4984c76d921601d7c  # v4.3.4
        with:
          fail-on-severity: high
          fail-on-scopes: runtime
          comment-summary-in-pr: always
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
          warn-on-openssf-scorecard-level: 3

  supply-chain-scan:
    name: Supply Chain Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install pip-audit
        run: pip install pip-audit
      
      - name: Run pip-audit
        id: pip-audit
        run: |
          # Scan for known vulnerabilities in Python dependencies
          pip-audit -r requirements.txt --desc --format json > pip-audit.json || true
          
          # Check if vulnerabilities were found
          if [ -s pip-audit.json ]; then
            echo "Vulnerabilities found, creating summary..."
            python -c "
          import json
          import sys
          
          with open('pip-audit.json', 'r') as f:
              data = json.load(f)
          
          vulns = data.get('dependencies', [])
          if not vulns:
              print('âœ… No vulnerabilities found')
              sys.exit(0)
          
          print(f'âš ï¸ Found {len(vulns)} vulnerable dependencies:')
          for vuln in vulns:
              pkg = vuln.get('name', 'unknown')
              version = vuln.get('version', 'unknown')
              print(f'  - {pkg}=={version}')
              for v in vuln.get('vulns', []):
                  cve = v.get('id', 'N/A')
                  desc = v.get('description', 'No description')[:100]
                  print(f'    â””â”€ {cve}: {desc}...')
          "
          else
            echo "âœ… No vulnerabilities found"
          fi
        continue-on-error: true
      
      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
        with:
          name: pip-audit-results
          path: pip-audit.json
          retention-days: 90
      
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8  # 0.24.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret,misconfig'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@afb54ba388a7dca6ecae48f608c4ff05ff4cc77a  # v3.25.15
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'dependency-scan'
      
      - name: Create summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”’ Supply Chain Security Scan Results
          
          ### Checks Performed
          - âœ… Dependency Review (license & vulnerability check)
          - âœ… pip-audit (Python package vulnerabilities)
          - âœ… Trivy (filesystem scan)
          
          ### View Results
          - Check the **Security** tab for detailed findings
          - Review **Actions artifacts** for raw scan data
          
          ### Next Steps
          If vulnerabilities were found:
          1. Review severity and exploitability
          2. Check if patches are available
          3. Update dependencies in `requirements.txt`
          4. Re-run scans to verify fixes
          EOF

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pip-licenses
          pip install -r requirements.txt
      
      - name: Check licenses
        run: |
          echo "## ðŸ“œ License Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | License |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          
          pip-licenses --format=markdown --order=license | tail -n +3 >> $GITHUB_STEP_SUMMARY
          
          # Check for problematic licenses
          PROBLEMATIC=$(pip-licenses --format=csv | grep -iE "GPL|AGPL|LGPL" || echo "")
          
          if [ -n "$PROBLEMATIC" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Attention Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found packages with copyleft licenses that may require review:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$PROBLEMATIC" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All licenses are permissive" >> $GITHUB_STEP_SUMMARY
          fi
