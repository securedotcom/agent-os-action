# Security Regression Test Templates

This directory contains **template tests** for security regression testing. These are NOT part of Argus's test suite - they are examples you can customize for your own application.

## Purpose

These templates help you create regression tests that ensure previously fixed security vulnerabilities don't reappear in your codebase. They were generated by Argus's security test generator and serve as starting points.

## How to Use

1. **Customize for your application**: Replace the placeholder imports (`app.file_processor`, `app.templates`) with your actual application modules.

2. **Copy to your test suite**: Copy the relevant test files to your application's test directory.

3. **Update test logic**: Modify the test assertions to match your application's behavior.

4. **Run with your test framework**: These tests use pytest, so run them with your existing pytest setup.

## Test Categories

### Command Injection (`command_injection/`)
Tests to verify that command injection vulnerabilities are fixed and stay fixed.

**Example:**
```python
from app.file_processor import process_file  # Replace with your module

def test_command_injection_regression():
    """Regression test: Ensure command injection is still fixed"""
    malicious_inputs = [
        "; cat /etc/passwd",
        "| cat /etc/passwd",
        "& cat /etc/passwd",
        "$(cat /etc/passwd)",
        "`cat /etc/passwd`",
    ]

    for malicious_input in malicious_inputs:
        try:
            result = process_file(malicious_input)
            # Verify command wasn't executed
            assert "root:" not in str(result)
        except (ValueError, SecurityError):
            # Expected: should raise error for malicious input
            pass
```

### Path Traversal (`path_traversal/`)
Tests to verify that path traversal vulnerabilities are fixed.

**Example:**
```python
from app.file_processor import read_file  # Replace with your module

def test_path_traversal_regression():
    """Regression test: Ensure path traversal is still fixed"""
    malicious_paths = [
        "../../../etc/passwd",
        "..\\..\\..\\windows\\system32\\config\\sam",
        "/etc/passwd",
        "C:\\Windows\\System32\\config\\SAM",
    ]

    for malicious_path in malicious_paths:
        with pytest.raises((ValueError, PermissionError, SecurityError)):
            read_file(malicious_path)
```

### SQL Injection (`sql_injection/`)
Tests to verify that SQL injection vulnerabilities are fixed.

**Example:**
```python
from app.database import get_user  # Replace with your module

def test_sql_injection_regression():
    """Regression test: Ensure SQL injection is still fixed"""
    malicious_inputs = [
        "1' OR '1'='1",
        "1; DROP TABLE users--",
        "1' UNION SELECT * FROM passwords--",
    ]

    for malicious_input in malicious_inputs:
        # Should not execute malicious SQL
        result = get_user(malicious_input)
        # Verify no unauthorized data access
        assert result is None or isinstance(result, dict)
```

### Cross-Site Scripting (XSS) (`xss/`)
Tests to verify that XSS vulnerabilities are fixed.

**Example:**
```python
from app.templates import render_user_input  # Replace with your module

def test_xss_regression():
    """Regression test: Ensure XSS is still fixed"""
    malicious_inputs = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror=alert('XSS')>",
        "javascript:alert('XSS')",
    ]

    for malicious_input in malicious_inputs:
        result = render_user_input(malicious_input)
        # Verify script tags are escaped/removed
        assert "<script>" not in result
        assert "onerror=" not in result
```

## Customization Guide

For each test file:

1. **Replace imports**: Update `from app.*` imports to point to your actual modules
2. **Update function calls**: Replace example functions with your actual functions
3. **Customize test cases**: Add/remove test cases based on your vulnerabilities
4. **Adjust assertions**: Modify assertions to match your security requirements
5. **Add context**: Include commit hashes, CVE IDs, or ticket numbers for traceability

## Integration with Argus

These tests complement Argus's scanning capabilities:

- **Argus scans** find vulnerabilities in code
- **Regression tests** ensure fixes don't break
- **Together** they provide defense-in-depth

## Best Practices

1. **Run on every commit**: Include these tests in your CI/CD pipeline
2. **Link to tickets**: Add comments linking to the original vulnerability report
3. **Update regularly**: Add new tests when new vulnerabilities are fixed
4. **Document fixes**: Include comments explaining what was fixed and how
5. **Test both positive and negative cases**: Verify malicious inputs fail AND normal inputs work

## Example: Complete Customization

**Before (template):**
```python
import pytest
from app.file_processor import process_file

def test_command_injection_regression():
    malicious_inputs = ["; cat /etc/passwd"]
    for malicious_input in malicious_inputs:
        try:
            result = process_file(malicious_input)
            assert "root:" not in str(result)
        except ValueError:
            pass
```

**After (customized):**
```python
import pytest
from myapp.core.file_handler import handle_upload  # Your actual module
from myapp.exceptions import InvalidInputError      # Your exception

def test_command_injection_regression():
    """
    Regression test for CVE-2024-1234 - Command injection in file upload
    Fixed in commit: abc123def456
    Ticket: SEC-789
    """
    malicious_inputs = [
        "; cat /etc/passwd",
        "| whoami",
        "$(uname -a)",
        # Add app-specific payloads
        "; rm -rf /var/lib/myapp/*",
    ]

    for malicious_input in malicious_inputs:
        # Your app should raise InvalidInputError
        with pytest.raises(InvalidInputError) as exc_info:
            handle_upload(malicious_input)

        # Verify error message doesn't leak system info
        assert "permission denied" not in str(exc_info.value).lower()

def test_normal_file_upload_still_works():
    """Ensure fix doesn't break legitimate functionality"""
    normal_files = ["document.pdf", "image.jpg", "report.csv"]
    for filename in normal_files:
        result = handle_upload(filename)
        assert result.success is True
```

## Running These Tests

**After customization**, add them to your test suite:

```bash
# Copy to your test directory
cp examples/regression_tests/command_injection/test_*.py tests/security/

# Run with pytest
pytest tests/security/ -v

# Run with coverage
pytest tests/security/ --cov=myapp --cov-report=html
```

## Need Help?

- See [Argus documentation](../../docs/) for more security testing guidance
- Review [ADR-0001](../../docs/adrs/0001-security-testing-strategy.md) for testing philosophy
- Check [scanner reference](../../docs/references/scanner-reference.md) for detection rules

## Contributing

If you create a useful regression test pattern, consider contributing it back:

1. Generalize your test to work as a template
2. Remove application-specific logic
3. Add clear documentation
4. Submit a PR to Argus

---

**Important**: These are TEMPLATES, not working tests. You MUST customize them for your application before use.
