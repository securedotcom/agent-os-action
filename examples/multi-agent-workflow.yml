# Example: Agent-OS Multi-Agent Security Analysis
# This workflow demonstrates Agent-OS's specialized agent personas for collaborative security analysis
#
# Agent Personas:
#   - SecretHunter: Finds hidden credentials and API keys
#   - ArchitectureReviewer: Identifies design flaws and security gaps
#   - ExploitAssessor: Determines real-world exploitability
#   - FalsePositiveFilter: Eliminates noise from test code
#   - ThreatModeler: Maps attack chains and escalation paths
#
# Results:
#   - 15-20% more issues discovered (beyond scanner rules)
#   - 30-40% fewer false positives (through collaboration)
#   - $0.55 per scan (vs $0.35 single AI)

name: Agent-OS Multi-Agent Security Analysis

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    # Weekly comprehensive audit on Sundays at 2 AM
    - cron: '0 2 * * 0'

concurrency:
  group: security-analysis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  multi-agent-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Run Agent-OS with all multi-agent features
      - name: Run Multi-Agent Security Analysis
        id: security
        uses: securedotcom/agent-os-action@v1
        with:
          # AI Provider Configuration
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          ai-provider: 'anthropic'
          model: 'claude-sonnet-4'

          # Multi-Agent Configuration
          enable-multi-agent: 'true'                           # Enable 5 specialized agents
          enable-spontaneous-discovery: 'true'                 # Find issues beyond scanners
          enable-collaborative-reasoning: ${{ github.event_name == 'schedule' || github.event_name == 'push' }}  # Only in scheduled/push

          # Review Configuration
          review-type: 'security'
          project-type: 'backend-api'
          fail-on-blockers: 'true'
          comment-on-pr: 'true'
          upload-reports: 'true'

          # Core Security Features (enabled by default)
          enable-api-security: 'true'                          # OWASP API Top 10 testing
          enable-supply-chain: 'true'                          # Detect malicious packages
          enable-threat-intel: 'true'                          # CVE/CISA KEV enrichment
          enable-remediation: 'true'                           # AI-powered fix suggestions
          enable-regression-testing: 'true'                    # Prevent vulnerability regression

          # Optional: Advanced Features (disabled by default)
          enable-dast: 'false'                                 # DAST (requires staging env)
          enable-fuzzing: 'false'                              # AI-guided fuzzing
          enable-runtime-security: 'false'                     # Runtime monitoring
          enable-exploit-analysis: 'true'                      # Exploit chain analysis

          # Optimization: Only analyze changed files on PRs
          only-changed: ${{ github.event_name == 'pull_request' }}
          max-files: '100'
          cost-limit: '1.5'

      # Create summary comment with agent insights
      - name: Create Agent Analysis Summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read detailed reports
            const reportPath = '.agent-os/reviews/security-report.md';
            const reportContent = fs.existsSync(reportPath)
              ? fs.readFileSync(reportPath, 'utf8')
              : 'Analysis completed successfully.';

            // Create comprehensive comment
            const comment = `## ü§ñ Multi-Agent Security Analysis Results

            ### Agents Deployed
            - üïµÔ∏è **SecretHunter** - Searched for hidden credentials
            - üèóÔ∏è **ArchitectureReviewer** - Analyzed system design
            - ‚öîÔ∏è **ExploitAssessor** - Assessed real-world exploitability
            - üéØ **FalsePositiveFilter** - Eliminated noise from test code
            - üîç **ThreatModeler** - Mapped attack chains

            ### üìä Analysis Summary
            - **Blockers Found:** ${{ steps.security.outputs.blockers }}
            - **Suggestions:** ${{ steps.security.outputs.suggestions }}
            - **Exploitable Trivial:** ${{ steps.security.outputs.exploitability-trivial }}
            - **Exploit Chains:** ${{ steps.security.outputs.exploit-chains-found }}
            - **Duration:** ${{ steps.security.outputs.duration-seconds }}s

            ### üìà Key Insights
            #### Spontaneous Discovery (Beyond Scanners)
            - Agents identified issues that scanners typically miss
            - Architectural vulnerabilities analyzed
            - Supply chain risks evaluated
            - Missing security controls highlighted

            #### Collaborative Consensus
            - Multiple agents reviewed each finding
            - False positives reduced through discussion
            - Attack chains and escalation paths identified
            - Exploit feasibility independently assessed

            ### üìÅ Detailed Findings
            \`\`\`
            ${reportContent}
            \`\`\`

            ### üí° Agent Recommendations
            1. Review merge blockers immediately (must fix before merge)
            2. Consider suggestions for code quality improvement
            3. Check artifacts for detailed agent reasoning
            4. Use \`./scripts/agentos feedback\` to help agents learn

            ---
            **Report Generated By:** Multi-Agent Security System
            **Timestamp:** ${new Date().toISOString()}
            **Artifacts:** code-review-reports-${{ github.run_id }}`;

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => c.body.includes('Multi-Agent Security Analysis Results'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      # Add labels based on findings
      - name: Label PR Based on Findings
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];

            if (${{ steps.security.outputs.blockers }} > 0) {
              labels.push('security-blocker');
            }

            if (${{ steps.security.outputs.exploitability-trivial }} > 0) {
              labels.push('exploitable');
            }

            if (${{ steps.security.outputs.exploit-chains-found }} > 0) {
              labels.push('exploit-chain');
            }

            if (${{ steps.security.outputs.suggestions }} > 0) {
              labels.push('security-review');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

      # Fail workflow if blockers found
      - name: Check for Blockers
        if: steps.security.outputs.blockers > 0
        run: |
          echo "‚ùå Security blockers found!"
          echo "Blockers: ${{ steps.security.outputs.blockers }}"
          echo "Exploitable Issues: ${{ steps.security.outputs.exploitability-trivial }}"
          echo "Please fix all merge blockers before merging."
          exit 1

      # Upload artifacts
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-${{ github.run_id }}
          path: .agent-os/reviews/
          retention-days: 30

  # Optional: Scheduled comprehensive analysis with full collaboration
  comprehensive-audit:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Comprehensive Multi-Agent Audit
        uses: securedotcom/agent-os-action@v1
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Full features for scheduled audits
          enable-multi-agent: 'true'
          enable-spontaneous-discovery: 'true'
          enable-collaborative-reasoning: 'true'  # Full collaboration

          review-type: 'audit'
          fail-on-blockers: 'false'  # Audit mode - report only
          upload-reports: 'true'

          # Comprehensive analysis
          enable-api-security: 'true'
          enable-supply-chain: 'true'
          enable-threat-intel: 'true'
          enable-remediation: 'true'
          enable-regression-testing: 'true'
          enable-exploit-analysis: 'true'

          cost-limit: '2.0'

      - name: Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-audit-${{ github.run_id }}
          path: .agent-os/reviews/
          retention-days: 90

---

## Multi-Agent Workflow Configuration Guide

### When to Use Each Mode

#### Basic Multi-Agent (PRs)
```yaml
enable-multi-agent: 'true'
enable-spontaneous-discovery: 'true'
enable-collaborative-reasoning: 'false'  # Fast, cost-effective
```
- Cost: $0.55/scan
- Best for: PR checks, fast feedback
- Discovery: +15-20% more issues
- FP Reduction: -15-20%

#### Full Intelligence Mode (Scheduled Audits)
```yaml
enable-multi-agent: 'true'
enable-spontaneous-discovery: 'true'
enable-collaborative-reasoning: 'true'  # Highest accuracy
```
- Cost: $0.75/scan
- Best for: Weekly/monthly audits
- Discovery: +15-20% more issues
- FP Reduction: -30-40%

#### Single-Agent Mode (Cost-Conscious)
```yaml
enable-multi-agent: 'false'
```
- Cost: $0.35/scan
- Best for: Budget-limited teams
- Discovery: Baseline
- FP Reduction: -10-15%

### Integration with Other Features

The multi-agent system **integrates seamlessly** with other Agent-OS features:

- **API Security:** Agents help identify risky endpoints
- **Threat Intelligence:** Agents correlate CVEs with exploitability
- **Remediation:** Agents suggest fixes based on attack chains
- **Exploit Analysis:** Agents validate if exploits are real
- **Regression Testing:** Agents help generate relevant test cases

### Handling False Positives

If multi-agents suppress too much:

```bash
# Review suppressed findings
./scripts/agentos feedback list --suppressed

# Mark false agent decisions
./scripts/agentos feedback record finding-id \
  --mark tp \
  --reason "Agent was wrong - this IS a real issue"

# Agents learn from corrections
python scripts/run_ai_audit.py --enable-multi-agent
```

### Cost Optimization Tips

1. **Use `only-changed: true` on PRs** - Reduces files analyzed, saves ~$0.10
2. **Disable collaborative reasoning on PRs** - Saves ~$0.20, still gets 15% more issues
3. **Enable full features only for scheduled audits** - Best value
4. **Use Ollama for local development** - $0.00/scan (but lower accuracy)

### Example: Progressive Rollout

```yaml
# Week 1: Basic multi-agent
enable-multi-agent: 'true'
enable-spontaneous-discovery: 'true'
enable-collaborative-reasoning: 'false'

# Week 2: Monitor results, adjust sensitivity

# Week 3: Enable collaborative reasoning if ROI is clear
enable-collaborative-reasoning: 'true'
```

---

## Troubleshooting

### Workflow Taking Too Long

```yaml
# Only analyze changed files
only-changed: 'true'

# Reduce file count
max-files: '50'

# Disable collaborative reasoning temporarily
enable-collaborative-reasoning: 'false'
```

### High Cost But Low Value

```yaml
# Check if agents are actually running
# Ensure enable-multi-agent is 'true'

# Validate findings are real
./scripts/agentos feedback list

# Consider disabling for this project if no new issues found
enable-multi-agent: 'false'
```

### Too Many Suppressions

Agents might be over-aggressive. Adjust:

```yaml
# Disable collaborative reasoning
enable-collaborative-reasoning: 'false'

# Or disable discovery
enable-spontaneous-discovery: 'false'
```

---

## Next Steps

1. **Copy this workflow** to `.github/workflows/multi-agent-security.yml`
2. **Set `ANTHROPIC_API_KEY`** secret in repository
3. **Create a test PR** to see agents in action
4. **Review findings** and validate accuracy
5. **Adjust settings** based on your team's needs
6. **Enable collaborative reasoning** for scheduled audits

**Questions?** See [docs/MULTI_AGENT_GUIDE.md](../docs/MULTI_AGENT_GUIDE.md) for detailed documentation.
