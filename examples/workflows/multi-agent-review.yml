# Multi-Agent Code Review Example
# Uses parallel agents for comprehensive analysis

name: Multi-Agent Code Review

on:
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  review:
    name: Comprehensive Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Run Multi-Agent Review
        uses: devatsecure/argus-action@v1
        with:
          # AI Configuration
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          multi_agent_mode: parallel
          
          # Analysis Scope
          only_changed: true  # PR mode - only changed files
          max_files: 50
          cost_limit: 2.00
          
          # Features
          enable_exploit_analysis: true
          generate_security_tests: true
          enable_threat_modeling: true
          
          # Policy
          fail_on_blockers: true
          severity_threshold: high
          comment_on_pr: true
      
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .argus/reviews/results.sarif
          category: argus
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ¤– AI Code Review Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f .argus/reviews/metrics.json ]; then
            echo "### ðŸ“Š Metrics" >> $GITHUB_STEP_SUMMARY
            cat .argus/reviews/metrics.json | jq -r '"- **Cost**: $\(.cost_usd)\n- **Files Analyzed**: \(.files_reviewed)\n- **Duration**: \(.duration_seconds)s\n- **Critical**: \(.findings.critical)\n- **High**: \(.findings.high)\n- **Medium**: \(.findings.medium)\n- **Low**: \(.findings.low)"' >> $GITHUB_STEP_SUMMARY
          fi
