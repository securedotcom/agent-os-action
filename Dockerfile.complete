FROM python:3.11-slim-bookworm

LABEL org.opencontainers.image.title="Agent-OS Complete Security Scanner"
LABEL org.opencontainers.image.description="All-in-one security scanner with 6-phase pipeline: SAST, CVE scanning, IaC security, secrets detection, AI triage, and sandbox validation"
LABEL org.opencontainers.image.vendor="Agent OS"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    ca-certificates \
    gnupg \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Trivy
RUN wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor -o /usr/share/keyrings/trivy.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | tee /etc/apt/sources.list.d/trivy.list && \
    apt-get update && \
    apt-get install -y trivy && \
    rm -rf /var/lib/apt/lists/*

# Install TruffleHog
RUN curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

# Install Gitleaks
RUN wget -qO - https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar -xzC /usr/local/bin

# Set Python environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONPATH=/app

WORKDIR /app

# Copy Python dependencies
COPY requirements.txt .

# Install Python packages including all scanners
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
    semgrep \
    checkov \
    pytm \
    anthropic \
    openai \
    tenacity \
    pyyaml \
    requests \
    rich

# Copy application code
COPY scripts/ ./scripts/
COPY policy/ ./policy/
COPY profiles/ ./profiles/
COPY schemas/ ./schemas/

# Create workspace and output directories
RUN mkdir -p /workspace /output && \
    chmod 755 /workspace /output

# Initialize Trivy database
RUN trivy image --download-db-only || true

WORKDIR /workspace

# Set entrypoint to the main scanner
ENTRYPOINT ["python", "/app/scripts/run_ai_audit.py"]

# Default: show help
CMD ["--help"]
