#!/usr/bin/env python3
"""
Sample exploit validation script
Demonstrates the sandbox validation system with a safe SQL injection example
"""

import json
import sys
from pathlib import Path

# Add scripts directory to path
sys.path.insert(0, str(Path(__file__).parent))

try:
    from docker_manager import DockerManager
    from sandbox_integration import (
        extend_review_metrics,
        update_sandbox_metrics,
    )
    from sandbox_validator import (
        ExploitConfig,
        ExploitType,
        SandboxValidator,
        ValidationResult,
    )
except ImportError as e:
    print(f"Error: {e}")
    print("Make sure all dependencies are installed: pip install docker")
    sys.exit(1)


def main():
    print("=" * 70)
    print("ARGUS SANDBOX VALIDATION - SAMPLE EXPLOIT DEMONSTRATION")
    print("=" * 70)
    print()

    # Check Docker availability
    print("[1/5] Checking Docker availability...")
    try:
        DockerManager()
        print("✓ Docker is available and running")
    except Exception as e:
        print(f"✗ Docker not available: {e}")
        print("\nPlease ensure Docker is installed and running:")
        print("  - Install Docker: https://docs.docker.com/get-docker/")
        print("  - Start Docker daemon")
        print(
            "  - Build sandbox image: docker build -f docker/security-sandbox.dockerfile -t argus-sandbox:latest ."
        )
        return 1

    print()

    # Create sample exploit
    print("[2/5] Creating sample SQL injection exploit...")
    exploit = ExploitConfig(
        name="SQL Injection - User Authentication Bypass",
        exploit_type=ExploitType.SQL_INJECTION,
        language="python",
        code="""
import sqlite3

print("[*] Setting up test database...")
# Create test database
conn = sqlite3.connect(':memory:')
cursor = conn.cursor()
cursor.execute('CREATE TABLE users (id INTEGER, username TEXT, password TEXT)')
cursor.execute("INSERT INTO users VALUES (1, 'admin', 'secret123')")
cursor.execute("INSERT INTO users VALUES (2, 'user', 'password456')")
conn.commit()
print("[*] Database created with 2 users")

print()
print("[*] Testing SQL injection payload...")
# Vulnerable query (for demonstration)
username = "admin' OR '1'='1"
query = f"SELECT * FROM users WHERE username = '{username}'"
print(f"[*] Query: {query}")

cursor.execute(query)
results = cursor.fetchall()

print(f"[*] Results: {len(results)} rows returned")
for row in results:
    print(f"    - User ID {row[0]}: {row[1]}")

if len(results) > 1:
    print()
    print("[+] SQL_INJECTION_SUCCESS")
    print("[+] Authentication bypass confirmed!")
    print("[+] Exploit allows access to all users without valid credentials")
else:
    print()
    print("[-] SQL injection failed")

conn.close()
""",
        expected_indicators=["SQL_INJECTION_SUCCESS"],
        timeout=30,
        metadata={
            "severity": "critical",
            "cwe": "CWE-89",
            "description": "SQL injection in user authentication",
        },
    )

    print(f"✓ Created exploit: {exploit.name}")
    print(f"  - Type: {exploit.exploit_type.value}")
    print(f"  - Language: {exploit.language}")
    print(f"  - Expected indicators: {', '.join(exploit.expected_indicators)}")
    print()

    # Validate exploit
    print("[3/5] Validating exploit in sandbox...")
    print("  (Creating isolated Docker container...)")

    try:
        validator = SandboxValidator()
        result = validator.validate_exploit(exploit, create_new_container=True)

        print()
        if result.result == ValidationResult.EXPLOITABLE.value:
            print("✓ Validation completed successfully!")
        elif result.result == ValidationResult.UNSAFE.value:
            print("✗ Exploit blocked by safety checks")
        else:
            print(f"⚠ Validation result: {result.result}")

        print()
        print(f"  Validation ID: {result.validation_id}")
        print(f"  Result: {result.result}")
        print(f"  Execution time: {result.execution_time_ms}ms")
        print(f"  Exit code: {result.exit_code}")
        print(
            f"  Indicators found: {len(result.indicators_found)}/{len(result.indicators_found) + len(result.indicators_missing)}"
        )

        if result.indicators_found:
            print(f"    ✓ {', '.join(result.indicators_found)}")

        if result.error_message:
            print(f"  Error: {result.error_message}")

        # Show stdout (first 500 chars)
        if result.stdout:
            print()
            print("  Exploit output:")
            for line in result.stdout.split("\n")[:15]:
                if line.strip():
                    print(f"    {line}")

    except Exception as e:
        print(f"✗ Validation failed: {e}")
        import traceback

        traceback.print_exc()
        return 1

    print()

    # Generate metrics
    print("[4/5] Generating metrics...")
    metrics = {"version": "1.0.16"}
    metrics = extend_review_metrics(metrics)
    metrics = update_sandbox_metrics(metrics, [result])

    print("✓ Metrics generated")
    print()
    print("  Sandbox Validation Metrics:")
    print(f"    Total validations: {metrics['sandbox_validation']['total_validations']}")
    print(f"    Exploitable: {metrics['sandbox_validation']['exploitable']}")
    print(f"    Not exploitable: {metrics['sandbox_validation']['not_exploitable']}")
    print(f"    Success rate: {metrics['sandbox_validation']['success_rate_percent']:.1f}%")
    print(f"    Avg execution time: {metrics['sandbox_validation']['avg_execution_time_ms']}ms")

    print()

    # Save results
    print("[5/5] Saving results...")
    results_dir = Path(".argus/sandbox-results")
    results_dir.mkdir(parents=True, exist_ok=True)

    # Save detailed result
    result_file = results_dir / f"{result.validation_id}.json"
    with open(result_file, "w") as f:
        json.dump(
            {
                "validation_id": result.validation_id,
                "exploit_name": result.exploit_name,
                "exploit_type": result.exploit_type,
                "result": result.result,
                "execution_time_ms": result.execution_time_ms,
                "indicators_found": result.indicators_found,
                "indicators_missing": result.indicators_missing,
                "timestamp": result.timestamp,
                "metadata": result.metadata,
            },
            f,
            indent=2,
        )

    print(f"✓ Detailed results saved to: {result_file}")

    # Save metrics
    metrics_file = results_dir / "sample_validation_metrics.json"
    with open(metrics_file, "w") as f:
        json.dump(metrics, f, indent=2)

    print(f"✓ Metrics saved to: {metrics_file}")

    print()
    print("=" * 70)
    print("VALIDATION COMPLETE")
    print("=" * 70)
    print()
    print("Summary:")
    print(f"  ✓ Exploit validated: {result.exploit_name}")
    print(f"  ✓ Result: {result.result}")
    print(f"  ✓ Execution time: {result.execution_time_ms}ms")
    print("  ✓ Safety checks: Passed")
    print("  ✓ Container cleanup: Completed")
    print()
    print("The sandbox validation system successfully:")
    print("  1. Created an isolated Docker container")
    print("  2. Executed the exploit code safely")
    print("  3. Analyzed the results")
    print("  4. Generated metrics")
    print("  5. Cleaned up all resources")
    print()
    print("Next steps:")
    print("  - Review results in .argus/sandbox-results/")
    print("  - Integrate with security-test-generator agent")
    print("  - Run additional exploit validations")
    print("  - Check documentation: docs/sandbox-validation.md")
    print()

    return 0


if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print("\n\nInterrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n✗ Unexpected error: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)
